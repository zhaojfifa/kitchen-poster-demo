<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>厨具海报生成 · 两步四区模板</title>
<meta name="description" content="两步生成：素材上传 → 海报生成。四分区：顶部Banner（Logo+主题）、左侧菜品图(30%)、右侧厨具主图(70%)+特性引线、底部产品列表。支持导出PNG与HTML。">
<style>
  :root{
    --bg:#f6f7fa; --ink:#0f172a; --muted:#64748b; --card:#fff; --line:#e2e8f0;
    --accent:#b8001f; --accent2:#f7d4db;
    --radius:18px; --pad:16px; --shadow:0 6px 24px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans","Noto Sans SC",sans-serif}
  .wrap{max-width:1120px;margin:auto;padding:24px}
  h1{font-size:24px;margin:0 0 6px}
  .muted{color:var(--muted)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:20px;box-shadow:var(--shadow);padding:20px}
  .tabs{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:14px 0 18px}
  .tab{padding:12px 14px;border:2px solid var(--line);border-radius:16px;background:#fff;text-align:left;cursor:pointer}
  .tab.active{border-color:#111827;box-shadow:0 0 0 4px rgba(17,24,39,.08)}
  label{font-weight:600;margin-bottom:6px;display:block}
  input[type="file"]{display:block}
  .preview-box{margin-top:8px;background:#f1f5f9;border:1px dashed #cbd5e1;border-radius:14px;display:grid;place-items:center;overflow:hidden}
  .preview-box img{max-width:100%;max-height:100%;object-fit:contain}
  .row{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  .row .col{min-width:0}
  .thumbs{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:8px}
  .thumbs img{width:100%;height:72px;object-fit:cover;border-radius:10px;border:1px solid #cbd5e1}
  .controls{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
  select,input[type="text"],textarea{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:12px;background:#fff}
  textarea{min-height:120px;resize:vertical}
  .btn{border:0;border-radius:16px;padding:12px 16px;font-weight:600;cursor:pointer}
  .btn.dark{background:#111827;color:#fff}
  .btn.green{background:#059669;color:#fff}
  .btn.indigo{background:#4f46e5;color:#fff}
  canvas{width:100%;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);background:#fff}
  .hint{color:var(--muted);font-size:12px;margin-top:6px}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .mt{margin-top:12px}
  .hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>厨具海报生成 · 模板化（四区）</h1>
    <div class="muted">两步：素材上传 → 海报生成；四区：Banner（Logo+主题）/ 左图3:7 / 右厨具+特性引线 / 底部产品列表。</div>
  </header>

  <div class="tabs">
    <button id="tab1" class="tab active">1. 素材上传</button>
    <button id="tab2" class="tab">2. 海报生成</button>
  </div>

  <!-- Step 1 -->
  <section id="step1" class="card">
    <h2 style="margin:0 0 14px;font-size:18px">步骤一：素材上传</h2>
    <div class="row">
      <div class="col">
        <label>上传公司 Logo（用于顶部 Banner 左侧）</label>
        <input id="imgLogo" type="file" accept="image/*">
        <div class="preview-box" style="aspect-ratio:3/1"><img id="previewLogo" alt=""></div>
        <button id="btnPickColors" class="btn mt" style="background:#fff;border:1px solid #d1d5db">从 Logo 取色 → 用作 Banner 渐变</button>
      </div>
      <div class="col">
        <label>左侧菜品/场景图（30% 宽）</label>
        <input id="imgLeft" type="file" accept="image/*">
        <div class="preview-box" style="aspect-ratio:16/9"><img id="previewLeft" alt=""></div>
      </div>
      <div class="col">
        <label>右侧厨具主图（70% 宽）</label>
        <input id="imgRight" type="file" accept="image/*">
        <div class="preview-box" style="aspect-ratio:16/9"><img id="previewRight" alt=""></div>
      </div>
    </div>

    <div class="grid2" style="margin-top:16px">
      <div>
        <div class="muted" style="font-weight:600;margin-bottom:6px">中文文案</div>
        <input id="cnBannerTitle" type="text" placeholder="Banner主题（如：专业级厨具）">
        <div class="mt"></div>
        <input id="cnBannerSub" type="text" placeholder="副标题（如：美味只需一个按钮）">
        <div class="mt"></div>
        <input id="cnRightTitle" type="text" placeholder="右侧厨具上方标题（如：双灶台 · 高效燃烧）">
        <div class="mt"></div>
        <textarea id="cnFeatures" placeholder="右侧厨具特性（每行一条，将自动引线到关键部位）
热电偶熄火保护
铸铁锅架
不锈钢面板
便捷旋钮
高效燃烧器"></textarea>
        <div class="mt"></div>
        <input id="cnListTitle" type="text" placeholder="底部产品列表标题（如：系列产品一览）">
      </div>
      <div>
        <label>底部产品列表缩略图（支持多选，最多 8 张）</label>
        <input id="imgList" type="file" accept="image/*" multiple>
        <div id="previewList" class="thumbs"></div>
        <div class="grid2" style="margin-top:16px">
          <div>
            <label>Banner 主色（左）</label>
            <input id="bannerColorL" type="color" value="#b8001f">
          </div>
          <div>
            <label>Banner 次色（右）</label>
            <input id="bannerColorR" type="color" value="#f8e9ed">
          </div>
        </div>
        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Banner 高度（%）</label>
            <input id="bannerH" type="range" min="10" max="22" value="14">
            <div class="hint">占整张海报高度的百分比</div>
          </div>
          <div>
            <label>阴影强度</label>
            <input id="shadow" type="range" min="0" max="24" value="10">
          </div>
        </div>
      </div>
    </div>

    <div class="flex mt">
      <button id="go2" class="btn dark">下一步：生成海报</button>
      <div class="hint">确认素材与文案后继续</div>
    </div>
  </section>

  <!-- Step 2 -->
  <section id="step2" class="card hidden">
    <h2 style="margin:0 0 12px;font-size:18px">步骤二：海报生成与导出</h2>

    <div class="controls">
      <div>
        <label>海报尺寸</label>
        <select id="posterSize">
          <option value="1240x1754">1240×1754（A4竖 · 预览）</option>
          <option value="2480x3508">2480×3508（A4竖 · 高清导出）</option>
          <option value="1080x1920">1080×1920（竖屏）</option>
        </select>
      </div>
      <div>
        <label>左:右 比例</label>
        <select id="split">
          <option value="3:7" selected>30% : 70%</option>
          <option value="4:6">40% : 60%</option>
          <option value="5:5">50% : 50%</option>
        </select>
      </div>
      <div>
        <label>底部最多展示</label>
        <select id="listMax">
          <option value="4">4 张</option>
          <option value="6" selected>6 张</option>
          <option value="8">8 张</option>
        </select>
      </div>
      <div>
        <label>风格模板</label>
        <select id="theme">
          <option value="classic" selected>经典（均衡）</option>
          <option value="bold">醒目（标题更大）</option>
          <option value="tech">技术感（右区网格）</option>
        </select>
      </div>
      <div style="align-self:end">
        <button id="btnRender" class="btn dark" style="width:100%">生成海报预览</button>
      </div>
    </div>

    <div class="flex mt">
      <button id="btnDownload" class="btn green">下载 PNG</button>
      <button id="btnShareHtml" class="btn indigo">导出可发布 HTML</button>
    </div>

    <div class="grid2" style="margin-top:16px;align-items:flex-start">
      <div><canvas id="canvas"></canvas></div>
      <div class="muted" style="font-size:13px">
        <div style="font-weight:700;color:#334155;margin-bottom:8px">模板说明</div>
        <ul style="margin:0 0 10px 18px">
          <li>顶部 Banner：左侧 Logo，中/右侧主题+副标题（可从 Logo 一键取色）。</li>
          <li>主体上半区：左图 3 / 右厨具 7；右侧可输入标题；特性每行一条，自动编号并以<strong>错落长度的虚线</strong>连到厨具锚点。</li>
          <li>底部列表标题：<strong>下移两行并居中</strong>，支持 4–8 张缩略图。</li>
          <li>导出：可下载 PNG 或生成自包含的 poster.html 便于发布。</li>
        </ul>
      </div>
    </div>
  </section>
</div>

<script>
/* ---------- Utils & State ---------- */
const $ = (id)=>document.getElementById(id);
window.addEventListener('error', e => console.error('[Poster Error]', e.message));

let lang = 'zh'; // 仅中文字号调整：主标题-2，副标题-1
let logoImg=null, leftImg=null, rightImg=null, listImgs=[];

/* ---------- Tabs ---------- */
function activate(step){
  const s1=$('step1'), s2=$('step2'), t1=$('tab1'), t2=$('tab2');
  if(step===1){ s1.classList.remove('hidden'); s2.classList.add('hidden'); t1.classList.add('active'); t2.classList.remove('active'); }
  else{ s2.classList.remove('hidden'); s1.classList.add('hidden'); t2.classList.add('active'); t1.classList.remove('active'); }
}
$('tab1').onclick=()=>activate(1);
$('tab2').onclick=()=>activate(2);
$('go2').onclick=()=>activate(2);

/* ---------- Image uploads + live preview ---------- */
function bindImage(inputEl, previewImg, cbStore){
  inputEl.addEventListener('change', ()=>{
    const f=inputEl.files && inputEl.files[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    previewImg.src = url;
    const img = new Image();
    img.onload = ()=>{ cbStore(img); };
    img.src = url;
  });
}
bindImage($('imgLogo'), $('previewLogo'), (img)=>{ logoImg=img; });
bindImage($('imgLeft'), $('previewLeft'), (img)=>{ leftImg=img; });
bindImage($('imgRight'), $('previewRight'), (img)=>{ rightImg=img; });

$('imgList').addEventListener('change', ()=>{
  listImgs = [];
  const wrap = $('previewList');
  wrap.innerHTML = '';
  [...$('imgList').files].slice(0,8).forEach(file=>{
    const url = URL.createObjectURL(file);
    const im = new Image();
    im.onload = ()=>{ listImgs.push(im); };
    im.src = url;
    const thumb = document.createElement('img');
    thumb.src = url;
    wrap.appendChild(thumb);
  });
});

/* ---------- Pick colors from Logo ---------- */
$('btnPickColors').onclick=()=>{
  if(!logoImg) return alert('请先上传 Logo');
  const c=document.createElement('canvas'), x=c.getContext('2d');
  c.width=logoImg.width; c.height=logoImg.height; x.drawImage(logoImg,0,0);
  const data = x.getImageData(0,0,c.width,c.height).data;
  let r=0,g=0,b=0,n=0;
  for(let i=0;i<data.length;i+=4){ const a=data[i+3]; if(a<16) continue; r+=data[i]; g+=data[i+1]; b+=data[i+2]; n++; }
  if(!n) return;
  r=Math.round(r/n); g=Math.round(g/n); b=Math.round(b/n);
  const hex = (R,G,B)=>('#'+[R,G,B].map(v=>('0'+v.toString(16)).slice(-2)).join(''));
  $('bannerColorL').value = hex(r,g,b);
  $('bannerColorR').value = hex(
    Math.min(255, Math.round(r*0.85+255*0.15)),
    Math.min(255, Math.round(g*0.85+255*0.15)),
    Math.min(255, Math.round(b*0.85+255*0.15))
  );
};

/* ---------- Text + Theme ---------- */
function getTextPack(){
  return {
    bannerTitle: $('cnBannerTitle').value || '专业级厨具',
    bannerSub:   $('cnBannerSub').value   || '美味只需一个按钮',
    rightTitle:  $('cnRightTitle').value  || '双灶台 · 高效燃烧',
    features:    ($('cnFeatures').value||'').split(/\n+/).filter(Boolean).slice(0,8),
    listTitle:   $('cnListTitle').value   || '系列产品一览'
  };
}

function getTheme(){
  const t = $('theme').value || 'classic';
  let th = (t==='bold') ? {title:.50, sub:.25, right:.036, feature:.024, radius:22, grid:false, weight:700}
        : (t==='tech') ? {title:.50, sub:.24, right:.032, feature:.020, radius:16, grid:true,  weight:600}
                        : {title:.50, sub:.24, right:.032, feature:.022, radius:18, grid:false, weight:600};
  // 中文规则：主标题 -2（约 8%）、副标题 -1（约 4%）
  if(lang==='zh'){ th.title*=0.92; th.sub*=0.96; }
  return th;
}

/* ---------- Canvas helpers ---------- */
const canvas=$('canvas'); const ctx=canvas.getContext('2d');
const RR=(x,y,w,h,r)=>{const rr=Math.min(r,w/2,h/2);ctx.beginPath();ctx.moveTo(x+rr,y);ctx.arcTo(x+w,y,x+w,y+h,rr);ctx.arcTo(x+w,y+h,x,y+h,rr);ctx.arcTo(x,y+h,x,y,rr);ctx.arcTo(x,y,x+w,y,rr);ctx.closePath();}
const drawContained=(img,x,y,w,h)=>{const ir=img.width/img.height, ar=w/h;let dw,dh,dx,dy;if(ir>ar){dh=h;dw=dh*ir;dx=x+(w-dw)/2;dy=y;}else{dw=w;dh=dw/ir;dx=x;dy=y+(h-dh)/2;}ctx.drawImage(img,dx,dy,dw,dh);}
const parseSize=(v)=>{const [w,h]=v.split('x').map(Number);return {w,h};}

/* staggered dashed link with variable curvature/length */
function dashedLink(tx,ty,ax,ay,i){
  ctx.save();
  const styles=[[6,6],[8,5],[5,7],[10,6]];
  ctx.setLineDash(styles[i%styles.length]);
  ctx.strokeStyle='rgba(0,0,0,0.6)';
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(tx,ty);
  const wiggle = 30 + (i%5)*12; // 长短错落
  const mx = (tx+ax)/2 + (i%2?-wiggle:wiggle);
  const my = (ty+ay)/2 + (i%3===0? wiggle*0.6 : -wiggle*0.4);
  ctx.quadraticCurveTo(mx,my,ax,ay);
  ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle='rgba(0,0,0,0.6)';
  ctx.beginPath();ctx.arc(tx,ty,3,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(ax,ay,3,0,Math.PI*2);ctx.fill();
  ctx.restore();
}
function badge(x0,y0,n){
  ctx.save();ctx.fillStyle='#0f172a';ctx.beginPath();ctx.arc(x0,y0,10,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#fff';ctx.font='700 12px system-ui';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(String(n),x0,y0+0.5);
  ctx.restore();
}

/* ---------- Renderer ---------- */
function renderPoster(){
  const {w,h} = parseSize($('posterSize').value);
  canvas.width=w; canvas.height=h;
  const pad = Math.round(w*0.035);
  const gap = Math.round(w*0.02);
  const th = getTheme();
  const shadow = Number($('shadow').value);
  const TP = getTextPack();

  // bg
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h);

  // banner
  const bh = Math.round(h * (Number($('bannerH').value)/100));
  const g = ctx.createLinearGradient(0,0,w,0);
  g.addColorStop(0, $('bannerColorL').value);
  g.addColorStop(1, $('bannerColorR').value);
  ctx.fillStyle = g; ctx.fillRect(0,0,w,bh);

  if(logoImg){
    const lh=Math.min(bh*0.72, Math.round(w*0.08));
    const lw=lh*(logoImg.width/logoImg.height);
    const lx=pad, ly=Math.round((bh-lh)/2);
    ctx.save(); RR(lx,ly,lw,lh,8); ctx.clip(); drawContained(logoImg,lx,ly,lw,lh); ctx.restore();
  }
  ctx.fillStyle='#fff'; ctx.textBaseline='alphabetic';
  ctx.font=`900 ${Math.round(bh*th.title)}px system-ui, 'Noto Sans SC'`;
  ctx.fillText(TP.bannerTitle, pad + (logoImg? Math.round(bh*0.85):0) + 16, Math.round(bh*0.66));
  ctx.fillStyle='rgba(255,255,255,.92)';
  ctx.font=`400 ${Math.round(bh*th.sub)}px system-ui, 'Noto Sans SC'`;
  ctx.fillText(TP.bannerSub, pad + (logoImg? Math.round(bh*0.85):0) + 16, Math.round(bh*0.92));

  // layout calc
  const bodyTop = bh + pad;
  const bodyH = h - bh - pad*2;
  const listH = Math.round(bodyH*0.28);
  const topH = bodyH - listH - gap;
  let [L,R] = $('split').value.split(':').map(Number);
  const total = L+R; L/=total; R/=total;
  const leftW = Math.round((w - pad*2 - gap) * L);
  const rightW= Math.round((w - pad*2 - gap) * R);

  // left
  const leftX=pad, leftY=bodyTop, leftH=topH;
  ctx.save(); ctx.shadowColor='rgba(0,0,0,.12)'; ctx.shadowBlur=shadow; ctx.shadowOffsetY=shadow/2;
  RR(leftX,leftY,leftW,leftH,th.radius); ctx.clip();
  if(leftImg){ drawContained(leftImg,leftX,leftY,leftW,leftH); }
  else{ ctx.fillStyle='#f1f5f9'; ctx.fillRect(leftX,leftY,leftW,leftH);
        ctx.fillStyle='#64748b'; ctx.font=`600 ${Math.round(w*0.02)}px system-ui`; ctx.fillText('上传左侧菜品/场景图', leftX+20, leftY+40); }
  ctx.restore();

  // right
  const rightX=pad+leftW+gap, rightY=bodyTop, rightH=topH;
  ctx.save(); ctx.shadowColor='rgba(0,0,0,.12)'; ctx.shadowBlur=shadow; ctx.shadowOffsetY=shadow/2;
  RR(rightX,rightY,rightW,rightH,th.radius); ctx.clip();
  ctx.fillStyle='#f8fafc'; ctx.fillRect(rightX,rightY,rightW,rightH);
  if(th.grid){
    ctx.save(); ctx.strokeStyle='rgba(2,6,23,.06)'; ctx.lineWidth=1;
    for(let gx=rightX;gx<rightX+rightW;gx+=16){ ctx.beginPath();ctx.moveTo(gx,rightY);ctx.lineTo(gx,rightY+rightH);ctx.stroke(); }
    for(let gy=rightY;gy<rightY+rightH;gy+=16){ ctx.beginPath();ctx.moveTo(rightX,gy);ctx.lineTo(rightX+rightW,gy);ctx.stroke(); }
    ctx.restore();
  }
  ctx.fillStyle='#0f172a';
  ctx.font=`800 ${Math.round(w*th.right)}px system-ui, 'Noto Sans SC'`;
  ctx.fillText(TP.rightTitle, rightX + Math.round(rightW*0.08), rightY + Math.round(rightH*0.14));

  if(rightImg){
    const px=rightX+Math.round(rightW*0.1), pw=rightW-Math.round(rightW*0.2);
    const ph=pw*(rightImg.height/rightImg.width);
    const py=rightY + Math.round(rightH*0.18);
    drawContained(rightImg,px,py,pw,ph);

    // anchors + label spots
    const anchors=[{x:px+pw*.2,y:py+ph*.22},{x:px+pw*.78,y:py+ph*.18},{x:px+pw*.25,y:py+ph*.82},{x:px+pw*.83,y:py+ph*.72},{x:px+pw*.5,y:py+ph*.45},{x:px+pw*.12,y:py+ph*.58},{x:px+pw*.9,y:py+ph*.33},{x:px+pw*.62,y:py+ph*.9}];
    const spots=[{x:rightX+28,y:rightY+48},{x:rightX+rightW-300,y:rightY+36},{x:rightX+28,y:rightY+rightH-36},{x:rightX+rightW-300,y:rightY+rightH-44},{x:rightX+28,y:rightY+rightH/2-6},{x:rightX+rightW-320,y:rightY+rightH/2+8},{x:rightX+rightW-320,y:rightY+rightH*.30},{x:rightX+60,y:rightY+rightH*.28}];
    ctx.fillStyle='#0f172a';
    ctx.font=`600 ${Math.round(w*th.feature)}px system-ui, 'Noto Sans SC'`;
    TP.features.forEach((t,i)=>{ if(i>=anchors.length) return; const a=anchors[i], s=spots[i];
      badge(s.x-14,s.y-10,i+1); ctx.fillText(t,s.x,s.y); dashedLink(s.x-6,s.y-12,a.x,a.y,i);
    });
  }else{
    ctx.fillStyle='#e2e8f0'; ctx.fillRect(rightX,rightY,rightW,rightH);
    ctx.fillStyle='#64748b'; ctx.font=`600 ${Math.round(w*0.02)}px system-ui`;
    ctx.fillText('上传右侧厨具主图（自动生成特性引线）', rightX+20, rightY+40);
  }
  ctx.restore();

  // bottom list title: down 2 lines + centered
  const listTitleBaseY = rightY + rightH + gap;
  const listTitleY = listTitleBaseY + Math.round(w*0.04); // 两行
  ctx.fillStyle='#0f172a'; ctx.textAlign='center';
  ctx.font=`800 ${Math.round(w*0.03)}px system-ui, 'Noto Sans SC'`;
  ctx.fillText(TP.listTitle, w/2, listTitleY);
  ctx.textAlign='left';

  // thumbs
  const listX = Math.round(w*0.035), listW = w - listX*2;
  const listY = listTitleY + Math.round(w*0.02);
  const maxItems = Number($('listMax').value);
  const items = (listImgs||[]).slice(0,maxItems);
  const cols = Math.min(items.length||4, maxItems);
  const spacing = Math.round(listW*.015);
  const cellW = Math.floor((listW - spacing*(cols-1)) / Math.max(cols,1));
  const hImg = Math.min(Math.round(w*0.16), (h - listY - Math.round(w*0.035)));
  items.forEach((img,i)=>{
    const x0 = listX + i*(cellW + spacing), y0=listY;
    ctx.save(); ctx.shadowColor='rgba(0,0,0,.1)'; ctx.shadowBlur=6; ctx.shadowOffsetY=3;
    RR(x0,y0,cellW,hImg,14); ctx.clip(); drawContained(img,x0,y0,cellW,hImg); ctx.restore();
  });
}

/* ---------- Buttons ---------- */
$('btnRender').onclick=()=>renderPoster();
$('btnDownload').onclick=()=>{
  if(!canvas.width) renderPoster();
  const url = canvas.toDataURL('image/png');
  const a=document.createElement('a'); a.href=url; a.download='poster.png'; a.click();
};
$('btnShareHtml').onclick=()=>{
  // embed images as data URLs
  function toData(img){
    try{
      if(!img) return '';
      const c=document.createElement('canvas'), x=c.getContext('2d');
      c.width=img.width; c.height=img.height; x.drawImage(img,0,0);
      return c.toDataURL('image/png');
    }catch(e){ return ''; }
  }
  const payload = {
    lang,
    fields:{
      cn:{
        bannerTitle:$('cnBannerTitle').value,
        bannerSub:$('cnBannerSub').value,
        rightTitle:$('cnRightTitle').value,
        features:$('cnFeatures').value,
        listTitle:$('cnListTitle').value
      }
    },
    options:{
      size:$('posterSize').value,
      split:$('split').value,
      bannerL:$('bannerColorL').value,
      bannerR:$('bannerColorR').value,
      bannerH:$('bannerH').value,
      shadow:$('shadow').value,
      listMax:$('listMax').value,
      theme:$('theme').value
    },
    images:{
      logo:toData(logoImg), left:toData(leftImg), right:toData(rightImg),
      list:(listImgs||[]).slice(0,8).map(toData)
    }
  };

  const exporter = (`<!doctype html><html lang="zh-CN"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>海报 Poster</title><style>html,body{margin:0;background:#0f172a;color:#e2e8f0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans','Noto Sans SC'} .wrap{min-height:100vh;display:grid;place-content:center;padding:24px} .card{background:#0b1220;border:1px solid #334155;border-radius:24px;box-shadow:0 10px 50px rgba(0,0,0,.5);padding:16px} canvas{max-width:min(92vw,1100px);height:auto;border-radius:16px;display:block}</style></head><body><div class="wrap"><div class="card"><canvas id="c"></canvas></div></div><script>const P=${JSON.stringify(payload)};const c=document.getElementById('c'), x=c.getContext('2d');const RR=(a,b,w,h,r)=>{const rr=Math.min(r,w/2,h/2);x.beginPath();x.moveTo(a+rr,b);x.arcTo(a+w,b,a+w,b+h,rr);x.arcTo(a+w,b+h,a,b+h,rr);x.arcTo(a,b+h,a,b,rr);x.arcTo(a,b,a+w,b,rr);x.closePath();};const draw=(src,a,b,w,h)=>{if(!src)return;const i=new Image();i.src=src;i.onload=()=>{const ir=i.width/i.height,ar=w/h;let dw,dh,dx,dy;if(ir>ar){dh=h;dw=dh*ir;dx=a+(w-dw)/2;dy=b;}else{dw=w;dh=dw/ir;dx=a;dy=b+(h-dh)/2;}x.drawImage(i,dx,dy,dw,dh);};};const parse=v=>{const s=v.split('x').map(Number);return{w:s[0],h:s[1]}};const wrap=str=>(str||'').split(/\n+/).filter(Boolean);function theme(){let t=P.options.theme||'classic';let th=(t==='bold')?{title:.50,sub:.25,right:.036,feature:.024,radius:22,grid:false,weight:700}:(t==='tech')?{title:.50,sub:.24,right:.032,feature:.020,radius:16,grid:true,weight:600}:{title:.50,sub:.24,right:.032,feature:.022,radius:18,grid:false,weight:600}; if(P.lang==='zh'){th.title*=.92; th.sub*=.96;} return th;}function badge(ax,ay,n){x.save();x.fillStyle='#0f172a';x.beginPath();x.arc(ax,ay,10,0,Math.PI*2);x.fill();x.fillStyle='#fff';x.font='700 12px system-ui';x.textAlign='center';x.textBaseline='middle';x.fillText(String(n),ax,ay+.5);x.restore();}function link(tx,ty,ax,ay,i){x.save();const d=[[6,6],[8,5],[5,7],[10,6]];x.setLineDash(d[i%d.length]);x.strokeStyle='rgba(0,0,0,.6)';x.lineWidth=2;x.beginPath();x.moveTo(tx,ty);const wig=30+(i%5)*12;const mx=(tx+ax)/2+(i%2?-wig:wig);const my=(ty+ay)/2+(i%3===0?wig*.6:-wig*.4);x.quadraticCurveTo(mx,my,ax,ay);x.stroke();x.setLineDash([]);x.beginPath();x.arc(tx,ty,3,0,Math.PI*2);x.fill();x.beginPath();x.arc(ax,ay,3,0,Math.PI*2);x.fill();x.restore();}function render(){const opt=P.options, th=theme(), S=parse(opt.size);c.width=S.w; c.height=S.h; const pad=Math.round(S.w*.035), gap=Math.round(S.w*.02); x.fillStyle='#fff'; x.fillRect(0,0,S.w,S.h); const bh=Math.round(S.h*(Number(opt.bannerH)/100)); const g=x.createLinearGradient(0,0,S.w,0); g.addColorStop(0,opt.bannerL); g.addColorStop(1,opt.bannerR); x.fillStyle=g; x.fillRect(0,0,S.w,bh); if(P.images.logo){ const li=new Image(); li.src=P.images.logo; li.onload=()=>{ const lh=Math.min(bh*.72,Math.round(S.w*.08)), lw=lh*(li.width/li.height), lx=pad, ly=Math.round((bh-lh)/2); x.save(); x.beginPath(); x.rect(lx,ly,lw,lh); x.clip(); x.drawImage(li,lx,ly,lw,lh); x.restore(); }; } const T={ title:P.fields.cn.bannerTitle||'专业级厨具', sub:P.fields.cn.bannerSub||'美味只需一个按钮', rtitle:P.fields.cn.rightTitle||'双灶台 · 高效燃烧', features:wrap(P.fields.cn.features), listTitle:P.fields.cn.listTitle||'系列产品一览' }; x.fillStyle='#fff'; x.textBaseline='alphabetic'; x.font='900 '+Math.round(bh*th.title)+'px system-ui, Noto Sans SC'; x.fillText(T.title, pad+(P.images.logo?Math.round(bh*.85):0)+16, Math.round(bh*.66)); x.fillStyle='rgba(255,255,255,.92)'; x.font='400 '+Math.round(bh*th.sub)+'px system-ui, Noto Sans SC'; x.fillText(T.sub, pad+(P.images.logo?Math.round(bh*.85):0)+16, Math.round(bh*.92)); const bodyTop=bh+pad, bodyH=S.h-bh-pad*2, listH=Math.round(bodyH*.28), topH=bodyH-listH-gap; let LR=opt.split.split(':'), L=+LR[0], R=+LR[1]; const tot=L+R; L/=tot; R/=tot; const leftW=Math.round((S.w-pad*2-gap)*L), rightW=Math.round((S.w-pad*2-gap)*R); const leftX=pad, leftY=bodyTop, leftH=topH; x.save(); x.beginPath(); x.rect(leftX,leftY,leftW,leftH); x.clip(); if(P.images.left){ draw(P.images.left,leftX,leftY,leftW,leftH); } else { x.fillStyle='#f1f5f9'; x.fillRect(leftX,leftY,leftW,leftH); } x.restore(); const rightX=pad+leftW+gap, rightY=bodyTop, rightH=topH; x.save(); x.beginPath(); x.rect(rightX,rightY,rightW,rightH); x.clip(); x.fillStyle='#f8fafc'; x.fillRect(rightX,rightY,rightW,rightH); if(th.grid){ x.save(); x.strokeStyle='rgba(2,6,23,.06)'; x.lineWidth=1; for(let gx=rightX;gx<rightX+rightW;gx+=16){ x.beginPath(); x.moveTo(gx,rightY); x.lineTo(gx,rightY+rightH); x.stroke(); } for(let gy=rightY;gy<rightY+rightH;gy+=16){ x.beginPath(); x.moveTo(rightX,gy); x.lineTo(rightX+rightW,gy); x.stroke(); } x.restore(); } x.fillStyle='#0f172a'; x.font='800 '+Math.round(S.w*th.right)+'px system-ui, Noto Sans SC'; x.fillText(T.rtitle, rightX+Math.round(rightW*.08), rightY+Math.round(rightH*.14)); if(P.images.right){ const ri=new Image(); ri.src=P.images.right; ri.onload=()=>{ const px=rightX+Math.round(rightW*.1), pw=rightW-Math.round(rightW*.2), ph=pw*(ri.height/ri.width), py=rightY+Math.round(rightH*.18); x.drawImage(ri,px,py,pw,ph); const anchors=[{x:px+pw*.2,y:py+ph*.22},{x:px+pw*.78,y:py+ph*.18},{x:px+pw*.25,y:py+ph*.82},{x:px+pw*.83,y:py+ph*.72},{x:px+pw*.5,y:py+ph*.45},{x:px+pw*.12,y:py+ph*.58},{x:px+pw*.9,y:py+ph*.33},{x:px+pw*.62,y:py+ph*.9}]; const spots=[{x:rightX+28,y:rightY+48},{x:rightX+rightW-300,y:rightY+36},{x:rightX+28,y:rightY+rightH-36},{x:rightX+rightW-300,y:rightY+rightH-44},{x:rightX+28,y:rightY+rightH/2-6},{x:rightX+rightW-320,y:rightY+rightH/2+8},{x:rightX+rightW-320,y:rightY+rightH*.30},{x:rightX+60,y:rightY+rightH*.28}]; x.fillStyle='#0f172a'; x.font='600 '+Math.round(S.w*th.feature)+'px system-ui, Noto Sans SC'; T.features.forEach((t,i)=>{ if(i>=anchors.length) return; const a=anchors[i], s=spots[i]; badge(s.x-14,s.y-10,i+1); x.fillText(t,s.x,s.y); link(s.x-6,s.y-12,a.x,a.y,i); }); }; } x.restore(); const listTitleBaseY=rightY+rightH+gap, listTitleY=listTitleBaseY+Math.round(S.w*.04); x.fillStyle='#0f172a'; x.textAlign='center'; x.font='800 '+Math.round(S.w*.03)+'px system-ui, Noto Sans SC'; x.fillText(T.listTitle, S.w/2, listTitleY); x.textAlign='left'; const listX=Math.round(S.w*.035), listW=S.w-listX*2, listY=listTitleY+Math.round(S.w*.02); const maxItems=Number(opt.listMax), items=(P.images.list||[]).slice(0,maxItems), cols=Math.min(items.length||4,maxItems); const spacing=Math.round(listW*.015), cellW=Math.floor((listW - spacing*(cols-1)) / Math.max(cols,1)), hImg=Math.min(Math.round(S.w*.16), (S.h - listY - Math.round(S.w*.035))); items.forEach((src,i)=>{ const x0=listX+i*(cellW+spacing), y0=listY; x.save(); x.beginPath(); x.rect(x0,y0,cellW,hImg); x.clip(); draw(src,x0,y0,cellW,hImg); x.restore(); }); } render();<\/script></body></html>`).replaceAll('</script>','<\/script>');

  const blob = new Blob([exporter], {type:'text/html'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='poster.html'; a.click();
};

/* initial render */
renderPoster();
</script>
</body>
</html>
